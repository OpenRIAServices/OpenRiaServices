queue:

  name: Hosted
  demands: 
  - DotNetFramework
  - msbuild
  - visualstudio
  - vstest

steps:

- task: NuGetInstaller@0
  displayName: 'NuGet restore RiaServices.sln'
  inputs:
    solution: '$(Parameters.solution)'
    nuGetVersion: 3.5.0.1829

- task: PowerShell@1
  displayName: 'PowerShell Script'
  inputs:
    scriptName: 'Setup-TestDatabases.ps1'

- task: VSBuild@1
  displayName: 'Build solution RiaServices.sln'
  inputs:
    solution: '$(Parameters.solution)'
    vsVersion: 14.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

- powershell: |
   # Write your powershell commands here.
   
   $port = 60002
   $iisExpressExe = "c:\Program Files (x86)\IIS Express\iisexpress.exe"
   $path = (Resolve-path "Test\WebsiteFullTrust")
   Write-Host $path
   Write-host "Starting site on port: $port"
   $params = "/port:$port /path:$path"
   $command = """$iisExpressExe"" $params"
   cmd /c start cmd /k "$command"
 
  displayName: 'Start test webserver'

- task: VSTest@2
  displayName: 'Test Assemblies **\$(BuildConfiguration)\*test*.dll;-:**\obj\**'
  inputs:
    testAssemblyVer2: |
     **\*test*.dll
     !**\obj\**
     !**\Silverlight\**

	runOnlyImpactedTests: false
    vsTestVersion: 14.0
    runInParallel: true
    codeCoverageEnabled: false
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    rerunFailedTests: true
    rerunFailedThreshold: 40
  timeoutInMinutes: 40
